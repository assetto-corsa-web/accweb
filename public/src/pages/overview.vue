<template>
	<layout>
		<div class="title">
			<h1>{{$t("title")}}</h1>
			<div class="menu">
				<button class="primary" v-on:click="$router.push('/server')" v-if="is_admin"><i class="fas fa-plus"></i> {{$t("add_new")}}</button>
				<button v-bind:class="stopAllClass" v-on:click="stopAllServers" v-if="is_mod || is_admin"><i class="fas fa-stop"></i> {{$t("stop_all")}}</button>
				<button v-on:click="loadServer(true)"><i class="fas fa-sync"></i> {{$t("refresh")}}</button>
				<button class="logout-btn" v-on:click="logout"><i class="fas fa-sign-out-alt"></i></button>
			</div>
		</div>
		<server v-for="s in orderedServers"
			:key="s.id"
			:server="s"
			:ro="!is_mod && !is_admin"
			v-on:copied="loadServer"
			v-on:deleted="loadServer"
			v-on:started="loadServer"
			v-on:stopped="loadServer"></server>
		<p v-if="!servers || !servers.length">No servers found.</p>
	</layout>
</template>

<script>
import axios from "axios";
import {layout, server, end} from "../components";
import _ from "lodash";

export default {
	components: {layout, server, end},
	data() {
		return {
      stopAllRunning: false,
			servers: []
		};
	},
	mounted() {
		this.refreshList();
	},
  computed: {
    orderedServers: function () {
      return _.orderBy(this.servers, 'name')
    },
    stopAllClass: function () {
      return {
        disabled: this.stopAllRunning
      }
    }
  },
	methods: {
		logout() {
			this.$store.commit("logout");
			this.$router.push("/login");
		},
		loadServer(refresh) {
			let timeout = 0;

			if(refresh) {
				this.servers = [];
				timeout = 100;
			}

			setTimeout(() => {
				axios.get("/api/servers")
				.then(r => {
					this.servers = r.data;
				})
				.catch(e => {
					this.$store.commit("toast", this.$t("receive_server_list_error"))
				});
			}, timeout);
		},
    stopAllServers() {
      this.stopAllRunning = true;
      axios.post("/api/servers/stop-all")
          .then(d => {
            this.loadServer(false);
            this.stopAllRunning = false
          })
          .catch(e => {
            this.$store.commit("toast", this.$t("stop_all_error"))
            this.stopAllRunning = false
          });
    },
		refreshList() {
			this.loadServer();
			setTimeout(() => {
				this.refreshList();
			}, 10000);
		}
	}
}
</script>

<style scoped>
.logout-btn .fas {
	margin: 0;
}
</style>

<i18n>
{
	"en": {
		"title": "Servers",
		"add_new": "Add Server",
    "stop_all": "Stop All Servers",
		"refresh": "Refresh",
		"receive_server_list_error": "Error receiving server list.",
    "stop_all_error": "Error while stopping all servers"
	}
}
</i18n>
